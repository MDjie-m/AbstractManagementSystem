<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renxin.psychology.mapper.PsyConsultMapper">

    <select id="search" resultType="com.renxin.psychology.domain.PsyConsult">
        select id, user_name, nicK_name, avatar, email, phonenumber, sex, tabs, way, way_str, wx_card, zx_word, zx_style, notice, experience, info, detail, serve, work_num, work_time, work_hours, del_flag, is_show, status, create_by, create_time, update_by, update_time,
        qualification, index_qualification, mode, city, province, genre, img, share, lang,
        is_new_people , device_id , device_brand, device_model, last_login_ip,
        (SELECT count(id) FROM psy_consult_work WHERE `live` != '[]' and `live` != `used` and consult_id = psy_consult.id and `day` = DATE_FORMAT(NOW(),'%Y-%m-%d')) buy,
        <!-- 筛选价格范围, 筛选服务对象, 取出符合条件的最低价 -->       
        (SELECT b.price FROM psy_consult_serve a INNER JOIN psy_consult_server_config b ON a.serve_id=b.id AND a.consult_id=psy_consult.id
            <if test="serviceObjectList != null and serviceObjectList.size > 0">
                and b.service_object in 
                <foreach collection="serviceObjectList" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            WHERE b.bound = 0
            <if test="lowPrice != null and highPrice != null">
                and b.price <![CDATA[>=]]> #{lowPrice} and b.price <![CDATA[<=]]> #{highPrice}
            </if>
            ORDER BY b.price ASC LIMIT 1) price,
        (SELECT b.price FROM psy_consult_serve a INNER JOIN psy_consult_server_config b ON a.serve_id=b.id AND a.consult_id=psy_consult.id 
            WHERE b.bound = 1 
            ORDER BY b.price ASC LIMIT 1) new_price
        from psy_consult
        <where>
            <!--  -->
            (SELECT b.price FROM psy_consult_serve a INNER JOIN psy_consult_server_config b ON a.serve_id=b.id AND a.consult_id=psy_consult.id
            <if test="serviceObjectList != null and serviceObjectList.size > 0">
                and b.service_object in
                <foreach collection="serviceObjectList" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            WHERE b.bound = 0
            <if test="lowPrice != null and highPrice != null">
                AND b.price <![CDATA[>=]]> #{lowPrice} AND b.price <![CDATA[<=]]> #{highPrice}
            </if>
            ORDER BY b.price ASC LIMIT 1) IS NOT NULL 
            and status = 0 and del_flag = 0 and is_show = 0
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="sex != null  and sex != ''"> and sex = #{sex}</if>
            <if test="city != null  and city != ''"> and city = #{city}</if>
            <if test="province != null  and province != ''"> and province = #{province}</if>
            <choose>
                <when test="nand != null and nand lt 1">
                    <if test="buy != null">
                        and (SELECT count(id) FROM psy_consult_work WHERE `live` != '[]' and `live` != `used` and consult_id = psy_consult.id and `day` = DATE_FORMAT(NOW(),'%Y-%m-%d')) <![CDATA[>]]> 0
                    </if>
                    and id in (
                    SELECT a.consult_id FROM psy_consult_serve a INNER JOIN psy_consult_server_config b on a.serve_id = b.id WHERE a.consult_id = psy_consult.id
                    <if test="single != null"> and b.type = 1</if>
                    <if test="serveId != null  and serveId != ''"> and b.id = #{serveId}</if>
                    <if test="lowPrice != null and highPrice != null">
                        and b.price <![CDATA[>=]]> #{lowPrice} and b.price <![CDATA[<=]]> #{highPrice}
                    </if>
                    GROUP BY a.consult_id
                    )
                </when>
                <when test="nand != null and nand gt 0">
                    and (
                        <if test="(serveId != null  and serveId != '') or lowPrice != null or highPrice != null">
                            id in (
                            SELECT a.consult_id FROM psy_consult_serve a INNER JOIN psy_consult_server_config b on a.serve_id = b.id and a.consult_id = psy_consult.id
                            <where>
                                <if test="single != null"> or b.type = 1</if>
                                <if test="serveId != null  and serveId != ''"> or b.id = #{serveId}</if>
                                <if test="lowPrice != null and lowPrice > 0">
                                    or b.price <![CDATA[>=]]> #{lowPrice}
                                </if>
                                <if test="highPrice != null and highPrice > 0">
                                    or b.price <![CDATA[<=]]> #{highPrice}
                                </if>
                            </where>
                            GROUP BY a.consult_id
                            )
                            <if test="buy != null">
                                or
                            </if>
                        </if>
                        <if test="buy != null">
                            (SELECT count(id) FROM psy_consult_work WHERE `live` != '[]' and `live` != `used` and consult_id = psy_consult.id and `day` = DATE_FORMAT(NOW(),'%Y-%m-%d')) <![CDATA[>]]> 0
                        </if>
                    )
                </when>
                <otherwise>
                    <if test="(serve != null  and serve != '') or (lowPrice != null and highPrice != null)">
                        and id in (
                        SELECT a.consult_id FROM psy_consult_serve a INNER JOIN psy_consult_server_config b on a.serve_id = b.id WHERE a.consult_id = psy_consult.id
                        <if test="serve != null  and serve != ''"> and b.`mode` = #{serve}</if>
                        <if test="lowPrice != null and highPrice != null">
                            and b.price <![CDATA[>=]]> #{lowPrice} and b.price <![CDATA[<=]]> #{highPrice}
                        </if>
                        GROUP BY a.consult_id
                        )
                    </if>
                </otherwise>
            </choose>
            <if test="ableWaitDay != null">
                and id in
                (
                SELECT DISTINCT consult_id
                FROM psy_consult_work
                WHERE `day` BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL ${ableWaitDay} DAY)
                AND (live IS NOT NULL AND live != '[]' and live != used)
                )
            </if>
            <if test="(time != null  and time != '') or (days != null and days.size() > 0)">
                and id in (
                    SELECT consult_id FROM psy_consult_work WHERE `status` = 0 and consult_id = psy_consult.id
                    <!--<choose>
                        <when test="time != null and time = '上午'">
                            and `time_start` <![CDATA[>=]]> '06:00' and `time_end` <![CDATA[<=]]> '12:00'
                        </when>
                        <when test="time != null and time = '下午'">
                            and `time_start` <![CDATA[>=]]> '12:00' and `time_end` <![CDATA[<=]]> '18:00'
                        </when>
                        <when test="time != null and time = '晚上'">
                            and `time_start` <![CDATA[>=]]> '18:00' and `time_end` <![CDATA[<=]]> '24:00'
                        </when>
                        <otherwise/>
                    </choose>-->
                <if test="time != null and time == '上午'">
                    and times like concat('%',#{time},'%')
                </if>
                
                <if test="days != null and days.size() > 0">
                        and `day` in
                        <foreach collection="days" index="index" item="item" open="(" separator="," close=")">
                            #{item,jdbcType=VARCHAR}
                        </foreach>
                </if>
                GROUP BY consult_id
                )
            </if>
        </where>
        order by IF(isnull(new_price),1,0), new_price asc, IF(isnull(price),1,0), price asc, id asc
    </select>

    <update id="tombstonedByIds">
        update psy_consult set del_flag = 1 where id in
        <foreach collection="array" item="item" open="(" separator="," close=")">
            #{item,jdbcType=BIGINT}
        </foreach>
    </update>

    <update id="updateServerNumZero">
        UPDATE psy_consult pc
        set pc.serve = 0 where pc.id is not null
    </update>
    
    <update id="refreshServerNum">
        UPDATE psy_consult pc
            LEFT JOIN (
                SELECT consult_id, COUNT(*) AS serve_count
                FROM psy_consult_serve
                where del_flag = 0 
                GROUP BY consult_id
            ) pcs
            ON pc.id = pcs.consult_id
        SET pc.serve = COALESCE(pcs.serve_count, 0) where pc.id is not null ;
    </update>
    
    <resultMap type="PsyConsult" id="PsyConsultResult">
        <result property="id"    column="id"    />
        <result property="userName"    column="user_name"    />
        <result property="nickName"    column="nicK_name"    />
        <result property="avatar"    column="avatar"    />
        <result property="img"    column="img"    />
        <result property="email"    column="email"    />
        <result property="phonenumber"    column="phonenumber"    />
        <result property="sex"    column="sex"    />
        <result property="tabs"    column="tabs"    />
        <result property="way"    column="way"    />
        <result property="wayStr"    column="way_str"    />
        <result property="info"    column="info"    />
        <result property="detail"    column="detail"    />
        <result property="serve"    column="serve"    />
        <result property="workNum"    column="work_num"    />
        <result property="workTime"    column="work_time"    />
        <result property="workHours"    column="work_hours"    />
        <result property="wxCard"    column="wx_card"    />
        <result property="zxWord"    column="zx_word"    />
        <result property="zxStyle"    column="zx_style"    />
        <result property="notice"    column="notice"    />
        <result property="experience"    column="experience"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="isShow"    column="is_show"    />
        <result property="status"    column="status"    />
        <result property="qualification"    column="qualification"    />
        <result property="indexQualification"    column="index_qualification"    />
        <result property="mode"    column="mode"    />
        <result property="city"    column="city"    />
        <result property="province"    column="province"    />
        <result property="genre"    column="genre"    />
        <result property="openId"    column="open_id"    />
        <result property="share"    column="share"    />
        <result property="lang"    column="lang"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="level"    column="level"    />
        <result property="serviceObject"    column="service_object"    />
        <result property="isNewPeople" column="is_new_people"/>
        <result property="deviceId" column="device_id"/>
        <result property="deviceBrand" column="device_brand"/>
        <result property="deviceModel" column="device_model"/>
        <result property="lastLoginIp" column="last_login_ip"/>
    </resultMap>

    <sql id="selectPsyConsultVo">
        select id,  user_name, nicK_name, mode, city, province, open_id, lang, genre, avatar, img, email, phonenumber, sex, tabs, way, way_str, 
               wx_card, zx_word, zx_style, notice, experience, info, detail, serve, work_num, work_time, work_hours, del_flag, is_show, status, 
               qualification, index_qualification, create_by, create_time, update_by, update_time, level,service_object,
               is_new_people , device_id , device_brand, device_model, last_login_ip
               from psy_consult
    </sql>

    <select id="getList" parameterType="PsyConsult" resultMap="PsyConsultResult">
        <include refid="selectPsyConsultVo"/>
        <where>
            <if test="userName != null  and userName != ''"> and user_name like concat('%', #{userName}, '%')</if>
            <if test="id != null  and id != ''"> and id = #{id}</if>
            <if test="tabs != null  and tabs != ''"> and tabs = #{tabs}</if>
            <if test="way != null  and way != ''"> and way = #{way}</if>
            <if test="sex != null  and sex != ''"> and sex = #{sex}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
            <if test="delFlag != null  and delFlag != ''"> and del_flag = #{delFlag}</if>
             
            <if test="level != null  and level != ''"> and level = #{level}</if>
            <if test="phonenumber != null  and phonenumber != ''"> and phonenumber = #{phonenumber}</if>
            <if test="idList != null and idList.size > 0">
                and id in
                <foreach collection="idList" open="(" close=")" separator="," item="item">
                    #{item}
                </foreach>
            </if>
            <if test="ableWaitDay != null and ableWaitDay != ''">
                and id in 
                (
                    SELECT DISTINCT consult_id
                    FROM psy_consult_work
                    WHERE `day` BETWEEN CURDATE() AND DATE_ADD(CURDATE(), INTERVAL ${ableWaitDay} DAY)
                        AND (live IS NOT NULL AND live != '[]' and live != used)
                )
            </if>
        </where>
        order by create_time desc 
    </select>
    
    <select id="queryById" resultType="com.renxin.psychology.domain.PsyConsult">
        select
            con.id, con.user_name, con.nick_name, con.mode, con.city, con.province, con.open_id, con.lang, con.genre, con.avatar, con.img,
            con.email, con.phonenumber, con.sex, con.tabs, con.way, con.way_str,con.wx_card, con.zx_word, con.zx_style, con.notice, con.experience, con.info, 
            con.detail, con.serve, con.work_num, con.work_time, con.work_hours, con.del_flag, con.is_show, con.status,
            con.qualification, con.index_qualification, con.create_by, con.create_time, con.update_by, con.update_time,
            con.level,con.service_object,
            con.is_new_people , con.device_id , con.device_brand, con.device_model, con.last_login_ip
        from
            psy_consult con 

        where con.id = #{id}

        
    </select>
    <select id="queryConsultantList" parameterType="PsyConsultOrder" resultType="com.renxin.psychology.domain.PsyConsult">
        SELECT
            IFNULL(od.server_name, '') AS serverName,
            IFNULL(od.pay_consultant_id, '') AS id,
            IFNULL(od.pay_consultant_name, '') AS nickName,
            IFNULL(cf.mode, '') AS mode,
            IFNULL(con.sex, '') AS sex,
            IFNULL(con.tabs, '') AS tabs,
            IFNULL(con.avatar, '') AS avatar,
            IFNULL(mo.max_order_date, '') AS maxOrderDate
        FROM psy_consultant_order od
         LEFT JOIN psy_consult con ON od.pay_consultant_id = con.id
         LEFT JOIN psy_consult_serve ser ON od.server_id = ser.relation_id
         LEFT JOIN psy_consult_server_config cf ON ser.serve_id = cf.id
         INNER JOIN (
                    SELECT
                        pay_consultant_id,
                        MAX(create_time) AS max_order_date
                    FROM psy_consultant_order
                    WHERE (server_type = 2 OR server_type = 3)
                    GROUP BY pay_consultant_id
                ) mo ON od.pay_consultant_id = mo.pay_consultant_id AND od.create_time = mo.max_order_date
        WHERE ser.consult_id = #{consultId}
        order by mo.max_order_date desc 
       <!-- <if test="pay != null  and pay != ''"> and od.pay = #{pay}</if>-->
    
    </select>

    <select id="queryConsultantListByServiceObject"
            resultType="com.renxin.psychology.domain.PsyConsult">
        select
        distinct con.id 
        from
        psy_consult con
        <!-- left join psy_consult_work wk on con.id = wk.consult_id and wk.status = 0 and wk.live != "[]"  -->
        left join psy_consult_serve ser on ser.consult_id = con.id
        left join psy_consult_server_config cf on ser.serve_id = cf.id
        where con.del_flag = 0 and con.status = 0 and con.is_show = 0
        <!--  and cf.type = 1 -->
        <if test="serviceObject != null  and serviceObject != ''"> and cf.service_object = #{serviceObject} </if>

      <!--  <if test="consultTabs != null  and consultTabs != ''"> and con.tabs like concat('%',#{consultTabs},'%')</if>
        <if test="consultGenre != null  and consultGenre != ''"> and con.genre like concat('%',#{consultGenre},'%')</if>

        <if test="waitDays != null  and waitDays != ''"> and wk.day >= CURDATE() AND day &lt; CURDATE() + INTERVAL #{waitDays} DAY</if>
        order by con.create_time desc-->
    </select>
    
    
</mapper>