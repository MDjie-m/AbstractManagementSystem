<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renxin.psychology.mapper.PsyConsultServeMapper">

    <delete id="deleteAllRelation">
        update psy_consult_serve
        set del_flag = 1
        where serve_id is not null
        <if test="serverConfigId != null and serverConfigId != ''">
            and serve_id = #{serverConfigId}
        </if>
        <if test="consultantId != null and consultantId != ''">
            and consult_id = #{consultantId}
        </if>
    </delete>

    <select id="getServeRef" resultType="com.renxin.psychology.vo.PsyConsultServeVO">
        select a.serve_id,a.consult_id, b.nick_name, b.user_name,b.status,
        (SELECT count(id) FROM psy_consult_order WHERE consult_id = a.consult_id and serve_id = a.serve_id and pay_status = '2') num
        from psy_consult_serve a inner join psy_consult b on a.consult_id = b.id
        <where>
            a.del_flag = 0
            <if test="consultId != null  and consultId != ''"> and a.consult_id = #{consultId}</if>
            <if test="serveId != null  and serveId != ''"> and a.serve_id = #{serveId}</if>
        </where>
    </select>

    <select id="getConsultServeRef" resultType="com.renxin.psychology.vo.PsyConsultServeVO">
        select distinct a.consult_id,b.nick_name, b.user_name from psy_consult_serve a inner join psy_consult b on a.consult_id = b.id
        <where>
            a.del_flag = 0
            <if test="consultId != null  and consultId != ''"> and a.consult_id = #{consultId}</if>
            <if test="serveId != null  and serveId != ''"> and a.serve_id = #{serveId}</if>
        </where>
    </select>

    <insert id="batchServeRef">
        insert into psy_consult_serve(serve_id, consult_id) values
        <foreach item="item" index="index" collection="list" separator=",">
            (#{item.serveId},#{item.consultId})
        </foreach>
    </insert>
    
    <select id="getServerDetailByRelationId" resultType="com.renxin.psychology.domain.PsyConsultServeConfig">
        select 
            re.relation_id as relationId,
            cf.id as id,
            cf.price as price,
            cf.name as name,
            cf.num as num,
            cf.level as level,
            cf.service_object as serviceObject,
            cf.mode,
            cf.time,
            con.id as consultantId,
            con.nick_name as consultantName,
            con.avatar as consultantAvatar,
            con.tabs as consultantTabs,
            con.info as consultantInfo
        from
            psy_consult_serve re 
        left join psy_consult_server_config cf on re.serve_id = cf.id 
        left join psy_consult con on re.consult_id = con.id
        where
            re.relation_id = #{id}
        
    </select>
</mapper>