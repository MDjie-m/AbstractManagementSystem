<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renxin.psychology.mapper.PsyConsultOrderMapper">

    <update id="tombstonedByIds">
        update psy_consult_work set del_flag = 1 where id in
        <foreach collection="array" item="item" open="(" separator="," close=")">
            #{item,jdbcType=BIGINT}
        </foreach>
    </update>

    <resultMap type="PsyConsultOrder" id="PsyConsultOrderResult">
        <result property="id"    column="id"    />
        <result property="orderNo"    column="order_no"    />
        <result property="consultId"    column="consult_id"    />
        <result property="consultName"    column="consult_name"    />
        <result property="refConsultId"    column="ref_consult_id"    />
        <result property="refConsultName"    column="ref_consult_name"    />
        <result property="serveId"    column="serve_id"    />
        <result property="serveName"    column="serve_name"    />
        <result property="userId"    column="user_id"    />
        <result property="nickName"    column="nick_name"    />
        <result property="amount"    column="amount"    />
        <result property="num"    column="num"    />
        <result property="buyNum"    column="buy_num"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="status"    column="status"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="pay"    column="pay"    />
        <result property="source"    column="source"    />
        <result property="channel"    column="channel"    />
        <result property="payTime"    column="pay_time"    />
        <result property="payStatus"    column="pay_status"    />
        <result property="orderTime"    column="order_time"    />
        <result property="remark"    column="remark"    />
        <result property="memo1"    column="memo1"    />
        <result property="reason"    column="reason"    />
        <result property="phone"    column="phone"    />
        <result property="originalPrice"    column="original_price"    />
        <result property="couponNo"    column="coupon_no"    />
        <result property="payParam"    column="pay_param"    />
    </resultMap>

    <sql id="selectPsyConsultOrderVo">
        select a.id, a.order_no, a.consult_id, a.ref_consult_id, a.ref_consult_name, a.consult_name, a.serve_id, a.serve_name, a.user_id, a.nick_name, a.amount, num, a.buy_num, a.del_flag,
               a.status, a.create_by, a.create_time, a.update_by, a.update_time, a.pay, a.source, a.channel, a.pay_time, a.pay_status, a.order_time, b.phone, a.remark, a.memo1, a.reason, a.consult_type,
               a.original_price,a.coupon_no,a.pay_param
        from psy_consult_order a
            left join psy_user b on a.user_id = b.id
    </sql>

    <select id="getList" parameterType="PsyConsultOrder" resultMap="PsyConsultOrderResult">
        <include refid="selectPsyConsultOrderVo"/>
        <where>
            <if test="orderNo != null  and orderNo != ''"> and a.order_no like concat('%', #{orderNo}, '%')</if>
            <if test="consultId != null "> and (a.consult_id = #{consultId} or a.ref_consult_id = #{consultId})</if>
            <if test="serveName != null  and serveName != ''"> and a.serve_name like concat('%', #{serveName}, '%')</if>
            <if test="nickName != null "> and a.nick_name like concat('%', #{nickName}, '%')</if>
            <if test="pay != null  and pay != ''"> and a.pay_status = #{pay}</if>
            <if test="userId != null  and userId != ''"> and a.user_id = #{userId}</if>
            <if test="source != null and source != ''"> and a.source = #{source}</if>
            <if test="status != null  and status != ''"> and a.status = #{status}</if>
            <if test="payStatus != null  and payStatus != ''"> and a.pay_status = #{payStatus}</if>
            <if test="delFlag != null  and delFlag != ''"> and a.del_flag = #{delFlag}</if>
            <if test="startTime != null "> and a.create_time <![CDATA[ >= ]]> #{startTime}</if>
            <if test="endTime != null "> and a.create_time <![CDATA[ <= ]]> #{endTime}</if>
        </where>
        order by a.create_time desc
    </select>

    <select id="getOrderList" resultType="com.renxin.psychology.dto.OrderListDTO">
        select a.id, a.order_no, a.consult_id, a.consult_name, a.ref_consult_id, a.ref_consult_name, a.serve_id, a.serve_name, a.user_id,a.remark,a.memo1,a.reason,
        a.nick_name, a.amount, a.num, a.buy_num, a.del_flag, a.status, a.create_by, a.order_time,a.pay_status,
        a.create_time, a.update_by, a.update_time, a.pay, a.source, a.channel, a.pay_time, b.avatar,
        a.original_price, a.coupon_no,
        s.mode, s.mode_name, s.num serve_num ,s.type, s.type_name, s.info, s.price, s.time, s.bound, s.bound_name, s.end,
        CASE
        WHEN a.STATUS = '0' THEN '待付款'
        WHEN a.STATUS = '1' THEN '进行中'
        WHEN a.STATUS = '2' THEN '已完成' ELSE '已关闭' END as status_name,
        (SELECT CONCAT(oi.day, ' ', oi.time_start)
        FROM psy_consult_order_item oi   WHERE oi.order_id = a.id and oi.status=0  order by oi.day asc,oi.time_start asc LIMIT 1) AS next_time,
        (SELECT oi.id
        FROM psy_consult_order_item oi   WHERE oi.order_id = a.id and oi.status=0  order by oi.day asc,oi.time_start asc LIMIT 1) AS nextItemId

        FROM psy_consult_order a
        INNER JOIN psy_consult b on a.consult_id = b.id
        INNER JOIN psy_consult_order_serve s on a.id = s.order_id and a.serve_id= s.serve_id
            <where>
            and a.status != '3'
            <if test="orderNo != null  and orderNo != ''"> and a.order_no = #{orderNo}</if>
            <if test="userId != null "> and a.user_id = #{userId}</if>
            <if test="status != null"> and a.status = #{status}</if>
            <if test="payStatus != null"> and a.pay_status = #{payStatus}</if>
            <if test="source != null and source != ''"> and a.source = #{source}</if>
            <if test="delFlag != null  and delFlag != ''"> and a.del_flag = #{delFlag}</if>
        </where>
    </select>

    <select id="getOrderDetail" resultType="com.renxin.psychology.dto.OrderDTO">
        select a.id, a.order_no, a.consult_id, a.consult_name, a.ref_consult_id, a.ref_consult_name, a.serve_id, a.serve_name, a.user_id,a.remark,a.memo1,a.reason,
               a.nick_name, a.amount, a.num, a.buy_num, a.del_flag, a.status, a.create_by, a.order_time,
               a.create_time, a.update_by, a.update_time, b.avatar,b.wx_card, a.pay, a.source, a.channel, a.pay_time,a.pay_status,c.phone,
               a.original_price, a.coupon_no,a.pay_param,
               CASE
                   WHEN a.STATUS = '0' THEN '待付款'
                   WHEN a.STATUS = '1' THEN '进行中'
                   WHEN a.STATUS = '2' THEN '已完成'
                   WHEN a.STATUS = '4' THEN '已关闭' ELSE '已取消' END as status_name
        FROM psy_consult_order a
                 INNER JOIN psy_consult b on a.consult_id = b.id
                 LEFT JOIN psy_user c on a.user_id = c.id
        where a.id = #{id}
    </select>
    
    
    <select id="queryUserList" parameterType="PsyConsultOrder" resultType="com.renxin.psychology.vo.PsyConsultOrderVO">
        SELECT
            COALESCE(a.order_no, '') AS order_no,
            COALESCE(a.serve_id, '') AS serve_id,
            COALESCE(a.serve_name, '') AS serve_name,
            COALESCE(a.user_id, '') AS user_id,
            COALESCE(a.nick_name, '') AS nick_name,
            COALESCE(b.phone, '') AS phone,
            COALESCE(b.sex, '') AS userSex,
            COALESCE(b.avatar, '') AS userAvatar,
            COALESCE(cf.mode, '') AS mode,
            COALESCE(label.user_fill_label, '') AS userFillLabel,
            COALESCE(label.consultant_fill_label, '') AS consultantFillLabel,
            COALESCE(label.admin_fill_label, '') AS adminFillLabel
        FROM
            (SELECT *
             FROM psy_consult_order a
             WHERE a.del_flag = 0
               AND a.create_time = (
                 SELECT MAX(a1.create_time)
                 FROM psy_consult_order a1
                 WHERE a1.user_id = a.user_id
                   AND a1.del_flag = 0
                   and a1.consult_type = 1 
                   AND (a1.consult_id = #{consultId} OR a1.ref_consult_id = #{consultId})
             )
               AND (a.consult_id = #{consultId} OR a.ref_consult_id = #{consultId}) and a.consult_type = 1
            ) a
                LEFT JOIN psy_user b ON a.user_id = b.id
                LEFT JOIN psy_user_label label ON a.user_id = label.user_id
                LEFT JOIN psy_consult_server_config cf ON a.serve_id = cf.id
        WHERE 1 = 1
          AND (a.consult_id = #{consultId} OR a.ref_consult_id = #{consultId}) and a.consult_type = 1
        GROUP BY a.order_no, a.serve_id, a.serve_name, a.user_id, a.nick_name, b.phone, cf.mode,
                 label.user_fill_label, label.consultant_fill_label, label.admin_fill_label
    </select>


</mapper>