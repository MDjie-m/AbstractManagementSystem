<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.renxin.psychology.mapper.PsyConsultWorkMapper">
    

    <select id="checkDataUnique" resultType="com.renxin.psychology.domain.PsyConsultWork">
        <include refid="selectPsyConsultWorkVo"/>
        where consult_id = #{consultId} and del_flag = 0
        and (time_start <![CDATA[ <= ]]> #{timeEnd} and time_end <![CDATA[ >= ]]> #{timeStart})
        <if test="id != null "> and id != #{id}</if>
    </select>

    <resultMap type="PsyConsultWork" id="PsyConsultWorkResult">
        <result property="id"    column="id"    />
        <result property="consultId"    column="consult_id"    />
        <result property="day"    column="day"    />
        <result property="week"    column="week"    />
        <result property="timeStart"    column="time_start"    />
        <result property="timeEnd"    column="time_end"    />
        <result property="times"    column="times"    />
        <result property="status"    column="status"    />
        <result property="used"    column="used"    />
        <result property="live"    column="live"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="consultType"    column="consult_type"    />
    </resultMap>

    <sql id="selectPsyConsultWorkVo">
        select id, consult_id, day, week, time_start, time_end, times, status, live, used, create_by, create_time, update_by, update_time,consult_type from psy_consult_work
    </sql>

    <select id="getList" parameterType="PsyConsultWork" resultMap="PsyConsultWorkResult">
        <include refid="selectPsyConsultWorkVo"/>
        <where>
            <if test="consultId != null "> and consult_id = #{consultId}</if>
            <if test="timeStart != null "> and time_start <![CDATA[ >= ]]> #{timeStart}</if>
            <if test="timeEnd != null "> and time_end <![CDATA[ <= ]]> #{timeEnd}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
        </where>
        order by time_start asc
    </select>

    <select id="getConsultIds" resultType="java.lang.Long">
        SELECT
        a.id
        FROM
        psy_consult a
        INNER JOIN psy_consult_work b ON a.id = b.consult_id
        <where>
            <if test="ids != null and ids.size() > 0">
                and b.consult_id in
                <foreach collection="ids" item="item" open="(" separator="," close=")">
                    #{item,jdbcType=BIGINT}
                </foreach>
            </if>
            <if test="start != null "> and b.day <![CDATA[ >= ]]> #{start}</if>
            <if test="end != null "> and b.day <![CDATA[ <= ]]> #{end}</if>
            <if test="status != null  and status != ''"> and b.status = #{status}</if>
        </where>
        GROUP BY a.id
        order by a.id
    </select>

    <select id="getWorks" resultType="com.renxin.psychology.vo.PsyConsultWorkVO">
        select b.nick_name, b.user_name, a.id, a.consult_id, a.day, a.week, a.time_start, a.time_end, a.status, a.live, a.used,a.consult_type from psy_consult_work a inner join psy_consult b on a.consult_id = b.id
        <where>
            <if test="ids != null and ids.size() > 0">
                and a.consult_id in
                <foreach collection="ids" item="item" open="(" separator="," close=")">
                    #{item,jdbcType=BIGINT}
                </foreach>
            </if>
            <if test="consultId != null "> and a.consult_id = #{consultId}</if>
            <if test="start != null "> and a.day <![CDATA[ >= ]]> #{start}</if>
            <if test="end != null "> and a.day <![CDATA[ <= ]]> #{end}</if>
            <if test="status != null  and status != ''"> and a.status = #{status}</if>
        </where>
        order by a.day asc
    </select>

    <select id="getOrderItems" resultType="com.renxin.psychology.vo.PsyConsultOrderItemVO">
        select b.order_id, b.day, b.time_start, b.time_end, a.nick_name create_by from psy_consult_order a
        INNER JOIN psy_consult_order_item b on a.id = b.order_id
        <where>
            <if test="status != null  and status != ''"> and a.pay_status = #{status}</if>
            <if test="start != null "> and b.day <![CDATA[ >= ]]> #{start}</if>
            <if test="end != null "> and b.day <![CDATA[ <= ]]> #{end}</if>
            <if test="consultId != null "> and a.consult_id = #{consultId}</if>
        </where>
    </select>

    <insert id="insertBatch" parameterType="PsyConsultWork">
        INSERT INTO psy_consult_work 
        (
            id,
            consult_id,
            day,
            week,
            time_start,
            times,
            live,
            used,
            time_end,
            status,
            consult_type,
            create_by,
            update_by,
            create_time,
            update_time
        )
        VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.id},
            #{item.consultId},
            #{item.day},
            #{item.week},
            #{item.timeStart},
            #{item.times},
            #{item.live},
            #{item.used},
            #{item.timeEnd},
            #{item.status},
            #{item.consultType},
            #{item.createBy},
            #{item.updateBy},
            #{item.createTime},
            #{item.updateTime}
            )
        </foreach>
    </insert>
    
</mapper>