<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.SysSupplierPriceMapper">
    
    <resultMap type="SysSupplierPrice" id="SysSupplierPriceResult">
        <result property="supplierPriceId"    column="supplier_price_id"    />
        <result property="supplierId"    column="supplier_id"    />
        <result property="productId"    column="product_id"    />
        <result property="supplierNameCn"    column="supplier_name_cn"    />
        <result property="supplierNameEn"    column="supplier_name_en"    />
        <result property="productName"    column="product_name"    />
        <result property="unitprice"    column="unitprice"    />
        <result property="unitpriceUnit"    column="unitprice_unit"    />
        <result property="priceRmb"    column="price_RMB"    />
        <result property="RMBQuoteUnit"    column="RMB_quote_unit"    />
        <result property="priceUsd"    column="price_USD"    />
        <result property="USDQuoteUnit"    column="USD_quote_unit"    />
        <result property="currency"    column="currency"    />
        <result property="time"    column="time"    />
        <result property="userId"    column="user_id"    />
        <result property="remarks"    column="remarks"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="futureField1"    column="future_field1"    />
        <result property="futureField2"    column="future_field2"    />
    </resultMap>

    <sql id="selectSysSupplierPriceVo">
        select ssp.supplier_price_id, ssp.supplier_id, ssp.product_id, ssp.supplier_name_cn, ssp.supplier_name_en, ssp.product_name,
               ssp.unitprice, ssp.unitprice_unit, ssp.price_RMB, ssp.RMB_quote_unit, ssp.price_USD, ssp.USD_quote_unit ,ssp.currency,ssp.time, ssp.user_id, ssp.remarks, ssp.del_flag,
        from sys_supplier_price ssp
        left join sys_product sp on sp.product_id = ssp.product_id

    </sql>

    <select id="selectSysSupplierPriceList" parameterType="SysSupplierPrice" resultMap="SysSupplierPriceResult">
        <include refid="selectSysSupplierPriceVo"/>
        <where>  del_flag = 0
            <if test="supplierId != null  and supplierId != ''"> and supplier_id = #{supplierId}</if>
            <if test="productId != null "> and product_id = #{productId}</if>
            <if test="supplierNameCn != null  and supplierNameCn != ''"> and supplier_name_cn = #{supplierNameCn}</if>
            <if test="supplierNameEn != null  and supplierNameEn != ''"> and supplier_name_en = #{supplierNameEn}</if>
            <if test="productName != null  and productName != ''"> and product_name like concat('%', #{productName}, '%')</if>
            <if test="unitprice != null  and unitprice != ''"> and unitprice = #{unitprice}</if>
            <if test="unitpriceUnit != null  and unitpriceUnit != ''"> and unitprice_unit = #{unitpriceUnit}</if>
            <if test="priceRmb != null "> and price_RMB = #{priceRmb}</if>
            <if test="RMBQuoteUnit != null  and RMBQuoteUnit != ''"> and RMB_quote_unit = #{RMBQuoteUnit}</if>
            <if test="priceUsd != null "> and price_USD = #{priceUsd}</if>
            <if test="USDQuoteUnit != null  and USDQuoteUnit != ''"> and USD_quote_unit = #{USDQuoteUnit}</if>
            <if test="currency != null "> and currency = #{currency}</if>
            <if test="time != null "> and time = #{time}</if>
            <if test="userId != null  and userId != ''"> and user_id = #{userId}</if>
            <if test="remarks != null  and remarks != ''"> and remarks = #{remarks}</if>
            <if test="futureField1 != null  and futureField1 != ''"> and future_field1 = #{futureField1}</if>
            <if test="futureField2 != null  and futureField2 != ''"> and future_field2 = #{futureField2}</if>
        </where>
    </select>
    
    <select id="selectSysSupplierPriceBySupplierPriceId" parameterType="String" resultMap="SysSupplierPriceResult">
        <include refid="selectSysSupplierPriceVo"/>
        where supplier_price_id = #{supplierPriceId}
        AND del_flag = 0;
    </select>

    <insert id="insertSysSupplierPrice" parameterType="SysSupplierPrice">
        insert into sys_supplier_price
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="supplierPriceId != null">supplier_price_id,</if>
            <if test="supplierId != null">supplier_id,</if>
            <if test="productId != null">product_id,</if>
            <if test="supplierNameCn != null">supplier_name_cn,</if>
            <if test="supplierNameEn != null">supplier_name_en,</if>
            <if test="productName != null">product_name,</if>
            <if test="unitprice != null">unitprice,</if>
            <if test="unitpriceUnit != null">unitprice_unit,</if>
            <if test="priceRmb != null">price_RMB,</if>
            <if test="RMBQuoteUnit != null">RMB_quote_unit,</if>
            <if test="priceUsd != null">price_USD,</if>
            <if test="USDQuoteUnit != null">USD_quote_unit,</if>
            <if test="currency != null">currency,</if>
            <if test="time != null">time,</if>
            <if test="userId != null">user_id,</if>
            <if test="remarks != null">remarks,</if>
            <if test="delFlag != null">del_flag,</if>
            <if test="futureField1 != null">future_field1,</if>
            <if test="futureField2 != null">future_field2,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="supplierPriceId != null">#{supplierPriceId},</if>
            <if test="supplierId != null">#{supplierId},</if>
            <if test="productId != null">#{productId},</if>
            <if test="supplierNameCn != null">#{supplierNameCn},</if>
            <if test="supplierNameEn != null">#{supplierNameEn},</if>
            <if test="productName != null">#{productName},</if>
            <if test="unitprice != null">#{unitprice},</if>
            <if test="unitpriceUnit != null">#{unitpriceUnit},</if>
            <if test="priceRmb != null">#{priceRmb},</if>
            <if test="RMBQuoteUnit != null">#{RMBQuoteUnit},</if>
            <if test="priceUsd != null">#{priceUsd},</if>
            <if test="USDQuoteUnit != null">#{USDQuoteUnit},</if>
            <if test="currency != null">#{currency},</if>
            <if test="time != null">#{time},</if>
            <if test="userId != null">#{userId},</if>
            <if test="remarks != null">#{remarks},</if>
            <if test="delFlag != null">#{delFlag},</if>
            <if test="futureField1 != null">#{futureField1},</if>
            <if test="futureField2 != null">#{futureField2},</if>
         </trim>
    </insert>

    <update id="updateSysSupplierPrice" parameterType="SysSupplierPrice">
        update sys_supplier_price
        <trim prefix="SET" suffixOverrides=",">
            <if test="supplierId != null">supplier_id = #{supplierId},</if>
            <if test="productId != null">product_id = #{productId},</if>
            <if test="supplierNameCn != null">supplier_name_cn = #{supplierNameCn},</if>
            <if test="supplierNameEn != null">supplier_name_en = #{supplierNameEn},</if>
            <if test="productName != null">product_name = #{productName},</if>
            <if test="unitprice != null  and unitprice != ''">unitprice = #{unitprice},</if>
            <if test="unitpriceUnit != null  and unitpriceUnit != ''">unitprice_unit = #{unitpriceUnit},</if>
            <if test="priceRmb != null">price_RMB = #{priceRmb},</if>
            <if test="RMBQuoteUnit != null  and RMBQuoteUnit != ''">RMB_quote_unit = #{RMBQuoteUnit},</if>
            <if test="priceUsd != null">price_USD = #{priceUsd},</if>
            <if test="USDQuoteUnit != null  and USDQuoteUnit != ''">USD_quote_unit = #{USDQuoteUnit},</if>
            <if test="currency != null ">currency = #{currency},</if>
            <if test="time != null">time = #{time},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="remarks != null">remarks = #{remarks},</if>
            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="futureField1 != null">future_field1 = #{futureField1},</if>
            <if test="futureField2 != null">future_field2 = #{futureField2},</if>
        </trim>
        where supplier_price_id = #{supplierPriceId}
        AND del_flag = 0;
    </update>

    <update id="deleteSysSupplierPriceBySupplierPriceId" parameterType="String">
        update sys_supplier_price
        set del_flag = 1
        where supplier_price_id = #{supplierPriceId}
    </update>

    <update id="deleteSysSupplierPriceBySupplierPriceIds" parameterType="String">
        update sys_supplier_price
        set del_flag = 1 where supplier_price_id in
        <foreach item="supplierPriceId" collection="array" open="(" separator="," close=")">
            #{supplierPriceId}
        </foreach>
    </update>

    <select id="productPriceStatistics" resultMap="SysSupplierPriceResult">
        SELECT
        ssp.supplier_price_id,
        ssp.supplier_id,
        ssp.product_id,
        ss.supplier_name_cn,
        ssp.supplier_name_en,
        ssp.product_name,
        ssp.unitprice,
        ssp.unitprice_unit,
        ssp.price_RMB,
        ssp.RMB_quote_unit,
        ssp.price_USD,
        ssp.USD_quote_unit,
        ssp.currency,
        ssp.time,
        ssp.user_id,
        ssp.remarks,
        ssp.del_flag
        FROM sys_supplier_price ssp
        LEFT JOIN sys_supplier ss ON ss.supplier_id = ssp.supplier_id
        WHERE ssp.product_id = #{productId}
        AND del_flag = 0
        AND (time BETWEEN #{startDate} AND #{endDate})
        <if test="supplierIds != null and !supplierIds.isEmpty()">
            AND ss.supplier_id IN
            <foreach item="supplier_id" collection="supplierIds" open="(" separator="," close=")">
                #{supplier_id}
            </foreach>
        </if>
    </select>
    <select id="getSuppliersByProductName" resultType="com.ruoyi.system.domain.vo.SupplierProductVo">
        SELECT
        sp.product_name as productName,
        ss.supplier_name_cn AS supplierName,
        ss.classification AS classification,
        sp.specifications AS specifications,
        ssp.price_RMB AS rmb,
        ssp.RMB_quote_unit AS rmbQuoteUnit,
        CONCAT(ssp.price_RMB,"/", ssp.RMB_quote_unit) AS quote,
        ss.rate AS inspectionRate,
        ss.review_rating AS auditRate,
        ssp.time AS priceDate
        FROM
        sys_supplier_price ssp
        LEFT JOIN
        sys_supplier ss ON ss.supplier_id = ssp.supplier_id
        LEFT JOIN
        sys_product sp ON sp.product_id = ssp.product_id
        WHERE ssp.del_flag = 0
        AND ( ssp.time BETWEEN #{startDate} AND #{endDate})
        <if test="productId != null  and productId != ''">AND ssp.product_id = #{productId}</if>
        <if test="classification != null  ">AND ss.classification = #{classification}</if>
    </select>

    <select id="getQuoteRows" resultType="integer">
        SELECT count(supplier_price_id) as quoteRows
        FROM sys_supplier_price ssp
        WHERE del_flag = 0
        <if test="productId != null">AND product_id = #{productId}</if>
    </select>

    <select id="getCnSupplierRows" resultType="integer">
        SELECT count(DISTINCT ss.supplier_id) as cnSupplierRows
        FROM sys_supplier ss
        left join sys_supplier_price ssp on ssp.supplier_id =  ss.supplier_id
        WHERE ss.delete_flag = 0
        AND ss.classification = 0
        <if test="productId != null">AND ssp.product_id = #{productId}</if>
    </select>

    <select id="getSupplierRows" resultType="integer">
        SELECT count(DISTINCT ss.supplier_id) as cnSupplierRows
        FROM sys_supplier ss
        left join sys_supplier_price ssp on ssp.supplier_id =  ss.supplier_id
        WHERE ss.delete_flag = 0
        AND ss.classification = 1
        <if test="productId != null">AND ssp.product_id = #{productId}</if>
</select>
</mapper>